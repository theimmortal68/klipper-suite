---
name: pi5
mmdebstrap:
  variant: apt
  packages: []

  customize-hooks:
    # Defensive: purge Debian generic kernels that may conflict with RPi meta-packages
    - >-
      chroot "$1" /bin/sh -eu -c '
        apt-get update || true
        DEBIAN_FRONTEND=noninteractive apt-get -y purge linux-image-arm64 linux-image-arm64-16k linux-image-arm64-unsigned linux-headers-arm64 || true
      '

    # Install Raspberry Pi 5 kernel/firmware/userland from RPi repo
    - >-
      chroot "$1" /bin/sh -eu -c '
        set -x
        export DEBIAN_FRONTEND=noninteractive
        apt-get update || true
        # Pi 5: 16K page kernel meta, bootloader, userland, EEPROM, Wi-Fi firmware
        apt-get -y install           linux-image-rpi-2712           raspberrypi-bootloader           libraspberrypi-bin           libraspberrypi0           rpi-eeprom           firmware-brcm80211 || true
      '

    # Crowsnest + ustreamer backend (default for Pi 5)
    - >-
      chroot "$1" /bin/sh -eu -c '
        echo "[camera] installing crowsnest with backend: ustreamer"
        export DEBIAN_FRONTEND=noninteractive
        apt-get update || true
        apt-get -y install git make gcc ca-certificates ffmpeg || true

        # Prefer RPi libcamera packages when present
        apt-get -y install libcamera0 libcamera-apps || apt-get -y install libcamera0 libcamera-tools || true

        # ustreamer via apt if available, else build from source
        if ! apt-get -y install ustreamer; then
          echo "[camera] apt ustreamer not found, building from source..." >&2
          apt-get -y install build-essential libevent-dev libjpeg-dev libbsd-dev pkg-config uuid-dev || true
          tmpdir=$(mktemp -d) && cd "$tmpdir"
          git clone --depth=1 https://github.com/pikvm/ustreamer.git
          make -C ustreamer
          install -Dm755 ustreamer/ustreamer /usr/local/bin/ustreamer
          rm -rf "$tmpdir"
        fi

        # Install Crowsnest
        if ! command -v crowsnest >/dev/null 2>&1; then
          tmpdir=$(mktemp -d) && cd "$tmpdir"
          git clone https://github.com/mainsail-crew/crowsnest.git
          cd crowsnest
          make install
          cd / && rm -rf "$tmpdir"
        fi

        # Default config
        CFGDIR=/etc/crowsnest
        install -d -m 0755 "$CFGDIR"
        CFG="$CFGDIR/crowsnest.conf"
        if [ ! -s "$CFG" ]; then
          cat > "$CFG" <<'EOF_CFG'
[crowsnest]
log_level: quiet

[cam main]
mode: ustreamer
device: /dev/video0
# Optional:
# resolution: 1280x720
# max_fps: 30
# port: 8080
EOF_CFG
        fi

        # Enable service if present
        if systemctl list-unit-files | grep -q "^crowsnest.service"; then
          systemctl enable crowsnest.service || true
        fi

        # Marker
        date -u +"%Y-%m-%dT%H:%M:%SZ" > /root/.pi5-camera-installed
      '
