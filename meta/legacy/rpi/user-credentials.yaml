---
name: rpi-user-creds
mmdebstrap:
  packages:
    - sudo
  customize-hooks:
    - chroot $1 sh -c "if ! id -u $KSconf_device_new_user >/dev/null 2>&1; then
        adduser --disabled-password --gecos \"\"  $KSconf_device_new_user;
        fi"
    - |-
      if [ -n "$KSconf_device_new_userpass" ] ; then
         chroot $1 sh -c "echo ${KSconf_device_new_user}:${KSconf_device_new_userpass} | chpasswd"
      fi
    - chroot $1 usermod --pass='*' root
    - chroot $1 sh -c "for GRP in input spi i2c gpio; do
         groupadd -f -r \$GRP;
      done"
    - chroot $1 sh -c "for GRP in adm dialout cdrom audio users sudo video games plugdev input spi i2c gpio ; do
         adduser $KSconf_device_new_user \$GRP;
      done"
    - sed "s/^pi /$KSconf_device_new_user /" $RPI_TEMPLATES/sudo/010_pi-nopasswd > $1/etc/sudoers.d/010_pi-nopasswd
    - mkdir -p $1/etc/profile.d
    - |-
      cat <<- 'EOCHROOT' > $1/etc/profile.d/01local.sh
      #!/bin/sh
      if [ "$(id -u)" -ne 0 ]; then
        PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games
      fi
      EOCHROOT
