---
name: openssh server
mmdebstrap:
  packages:
    - openssh-server
  customize-hooks:
    - mkdir -p $1/home/${KSconf_device_new_user}/.ssh
    - |-
      if [ -z ${KSconf_meta_ssh_pubkey_new_user+x} ]; then
         touch $1/home/${KSconf_device_new_user}/.ssh/authorized_keys
      elif [ -f "$KSconf_meta_ssh_pubkey_new_user" ] ; then
         cat $KSconf_meta_ssh_pubkey_new_user > $1/home/${KSconf_device_new_user}/.ssh/authorized_keys
      else
         echo "$KSconf_meta_ssh_pubkey_new_user" > $1/home/${KSconf_device_new_user}/.ssh/authorized_keys
      fi
    - |-
      if ksconf isy meta_sshd_pubkey_only ; then
         mkdir -p $1/etc/ssh/sshd_config.d
         cat <<- 'EOCHROOT' > $1/etc/ssh/sshd_config.d/01pubkey-only.conf
      PermitRootLogin no
      ChallengeResponseAuthentication no
      PasswordAuthentication no
      GSSAPIAuthentication no
      UsePAM yes
      PubkeyAuthentication yes
      AuthenticationMethods publickey
      EOCHROOT
      fi
    - $BDEBSTRAP_HOOKS/enable-units "$1" ssh
