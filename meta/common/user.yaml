---
name: user
mmdebstrap:
  variant: apt
  packages: []   # NOTE: assumes 'sudo' comes from ratos-prerequisite
  customize-hooks:
    - >
      chroot "$1" sh -eu -c '
        U="${KSconf_device_new_user:?KSconf_device_new_user must be set}"

        # 1) (Optional) set password if provided (plaintext or crypt hash)
        if [ -n "${KSconf_device_new_userpass:-}" ]; then
          P="${KSconf_device_new_userpass}"
          case "$P" in
            \$6\$*|\$5\$*|\$2*|\$y\$*|\$argon2*) echo "$U:$P" | chpasswd -e ;;
            *)                                   echo "$U:$P" | chpasswd    ;;
          esac
        fi

        # 2) Lock root account
        usermod -p "*" root

        # 3) Ensure groups exist (will fail if already present â€” per no-idempotence preference)
        for GRP in input spi i2c gpio render; do
          groupadd -r "$GRP"
        done

        # 4) Add the device user to groups (authoritative here)
        for GRP in adm dialout cdrom audio users sudo video games plugdev input spi i2c gpio tty render; do
          adduser "$U" "$GRP"
        done

        # 5) Sudoers drop-in created in-chroot (no host-side templating)
        install -d -m 0755 /etc/sudoers.d
        cat >/etc/sudoers.d/010_"$U"-nopasswd <<EOF
        $U ALL=(ALL) NOPASSWD:ALL
        EOF
        chmod 0440 /etc/sudoers.d/010_"$U"-nopasswd
        sh -eu -c "command -v visudo >/dev/null && visudo -cf /etc/sudoers.d/010_\"$U\"-nopasswd || true"

        # 6) PATH normalization for non-root shells
        install -d -m 0755 /etc/profile.d
        cat >/etc/profile.d/01local.sh <<'"'"'SH'"'"'
        #!/bin/sh
        if [ "$(id -u)" -ne 0 ]; then
          PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games
        fi
        SH
        chmod 0644 /etc/profile.d/01local.sh
      '
