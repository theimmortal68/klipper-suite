---
name: user
mmdebstrap:
  variant: apt
  packages: []
  customize-hooks:
    - >
      chroot "$1" sh -eu -c '
        # Decide the device user from available envs (first non-empty wins)
        if [ -n "${KSconf_device_new_user:-}" ]; then
          U="$KSconf_device_new_user"
          echo "[user hook] Using KSconf_device_new_user=$U" >&2
        elif [ -n "${KSconf_device_user:-}" ]; then
          U="$KSconf_device_user"
          echo "[user hook] Using KSconf_device_user=$U" >&2
        elif [ -n "${IGconf_device_user1:-}" ]; then
          U="$IGconf_device_user1"
          echo "[user hook] Using IGconf_device_user1=$U" >&2
        else
          echo "[user hook] ERROR: no user variable set" >&2
          exit 1
        fi

        # 0) Create the user
        adduser --disabled-password --gecos "" "$U"

        # 1) Optionally set password
        if [ -n "${KSconf_device_new_userpass:-${KSconf_device_password:-}}" ]; then
          P="${KSconf_device_new_userpass:-${KSconf_device_password}}"
          echo "[user hook] Setting password for $U" >&2
          case "$P" in
            \$6\$*|\$5\$*|\$2*|\$y\$*|\$argon2*) echo "$U:$P" | chpasswd -e ;;
            *)                                   echo "$U:$P" | chpasswd    ;;
          esac
        else
          echo "[user hook] No password set for $U" >&2
        fi

        # 2) Lock root
        usermod -p "*" root

        # 3) Ensure common hw groups exist
        for GRP in input spi i2c gpio render; do
          groupadd -r "$GRP"
        done

        # 4) Add user to groups
        for GRP in adm dialout cdrom audio users sudo video games plugdev input spi i2c gpio tty render; do
          adduser "$U" "$GRP"
        done

        # 5) Sudoers drop-in
        install -d -m 0755 /etc/sudoers.d
        printf "%s ALL=(ALL) NOPASSWD:ALL\n" "$U" >/etc/sudoers.d/010_"$U"-nopasswd
        chmod 0440 /etc/sudoers.d/010_"$U"-nopasswd
        chown root:root /etc/sudoers.d/010_"$U"-nopasswd

        # 6) PATH normalization
        install -d -m 0755 /etc/profile.d
        cat <<'"'"'SH'"'"' >/etc/profile.d/01local.sh
        #!/bin/sh
        if [ "$(id -u)" -ne 0 ]; then
          PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games
        fi
        SH
        chmod 0644 /etc/profile.d/01local.sh
      '        install -d -m 0755 /etc/sudoers.d
        cat >/etc/sudoers.d/010_"$U"-nopasswd <<EOF
        $U ALL=(ALL) NOPASSWD:ALL
        EOF
        chmod 0440 /etc/sudoers.d/010_"$U"-nopasswd
        sh -eu -c "command -v visudo >/dev/null && visudo -cf /etc/sudoers.d/010_\"$U\"-nopasswd || true"

        # 6) PATH normalization for non-root shells
        install -d -m 0755 /etc/profile.d
        cat >/etc/profile.d/01local.sh <<'"'"'SH'"'"'
        #!/bin/sh
        if [ "$(id -u)" -ne 0 ]; then
          PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games
        fi
        SH
        chmod 0644 /etc/profile.d/01local.sh
      '        EOF
        chmod 0440 /etc/sudoers.d/010_"$U"-nopasswd
        sh -eu -c "command -v visudo >/dev/null && visudo -cf /etc/sudoers.d/010_\"$U\"-nopasswd || true"

        # 6) PATH normalization for non-root shells
        install -d -m 0755 /etc/profile.d
        cat >/etc/profile.d/01local.sh <<'"'"'SH'"'"'
        #!/bin/sh
        if [ "$(id -u)" -ne 0 ]; then
          PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games
        fi
        SH
        chmod 0644 /etc/profile.d/01local.sh
      '
