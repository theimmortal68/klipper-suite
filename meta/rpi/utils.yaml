---
name: rpi-utils
mmdebstrap:
  variant: apt
  packages:
    - raspi-config
    - rpi-eeprom
    - raspi-utils
    - raspi-utils-core
    - raspi-utils-dt
    - flashrom
    - i2c-tools
    - dphys-swapfile
    - ca-certificates
    - curl
    - wget
    - iproute2
    - iputils-ping
    - sudo
    - micro
    - less
    - bash-completion
    - openssh-client
    - procps
    - udev
    - zstd
    - fake-hwclock
  customize-hooks:
    - |-
      chroot "$1" /bin/sh -eu -c '
        # --- Enable i2c-dev (modern, drop-in style) ---
        install -d -m 0755 /etc/modules-load.d
        printf "%s\n" "i2c-dev" > /etc/modules-load.d/i2c.conf

        # --- dphys-swapfile "drop-in" via diversion ---
        # dphys-swapfile has no conf.d; divert vendor file and install a managed wrapper
        if dpkg -s dphys-swapfile >/dev/null 2>&1; then
          # Add diversion if not already present; rename moves the current file aside
          dpkg-divert --quiet --local --add --rename --divert /etc/dphys-swapfile.distrib /etc/dphys-swapfile
          # Write our managed config
          printf "%s\n" \
            "# Managed by image build. Local overrides first:" \
            "CONF_SWAPSIZE=1024" \
            "CONF_MAXSWAP=4096" \
            "" \
            "# Source the vendor defaults (diverted by dpkg-divert) so we inherit future sane defaults." \
            "# Variables set above remain in effect unless the vendor file explicitly overrides them." \
            "if [ -r /etc/dphys-swapfile.distrib ]; then" \
            "  . /etc/dphys-swapfile.distrib" \
            "fi" \
            > /etc/dphys-swapfile
          chmod 0644 /etc/dphys-swapfile
        fi
      '
    - |-
      printf %s\n "      ::1     ip6-localhost ip6-loopback" "      fe00::0 ip6-localnet" "      ff00::0 ip6-mcastprefix" "      ff02::1 ip6-allnodes" "      ff02::2 ip6-allrouters" "" "      127.0.0.1   localhost" "      127.0.1.1   \$KSconf_device_hostname" > $1/etc/hosts
    - |-
      chroot "$1" /bin/sh -eu -c '
        # Make micro the default editor
        update-alternatives --install /usr/bin/editor editor /usr/bin/micro 50
        update-alternatives --set editor /usr/bin/micro

        # Export EDITOR/VISUAL for all users
        install -d -m 0755 /etc/profile.d
        printf "%s\n" \
          "export EDITOR=/usr/bin/micro" \
          "export VISUAL=/usr/bin/micro" \
          > /etc/profile.d/99-editor.sh
        chmod 0644 /etc/profile.d/99-editor.sh

        # Seed /etc/skel with micro settings
        install -d -m 0755 /etc/skel/.config/micro
        printf "%s\n" \
          "{" \
          "  \"softwrap\": true," \
          "  \"tabsize\": 2," \
          "  \"autosu\": true" \
          "}" \
          > /etc/skel/.config/micro/settings.json
        chmod 0644 /etc/skel/.config/micro/settings.json
      '
    - date -d "@${SOURCE_DATE_EPOCH}" > $1/etc/fake-hwclock.data
    - $BDEBSTRAP_HOOKS/enable-units "$1" fake-hwclock
